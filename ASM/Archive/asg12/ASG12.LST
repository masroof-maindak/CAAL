     1                                  ; Dispatcher for a scheduler
     2                                  org 100h
     3                                  
     4 00000000 E9AB22                  jmp start
     5                                  
     6 00000003 00000000                oldtt: dd 0
     7 00000007 0000<rept>              PCB: times 16*16 dw 0     ; process control block - for 32 bytes/thread
     8 00000207 0000<rept>              stacks: times 256*16 dw 0 ; 512 bytes per stack per program
     9 00002207 0000                    currProc: dw 0
    10                                  
    11                                  ;structure of one chunk in the PCB:
    12                                  ; 02 bytes - prev/next pointers
    13                                  ; 02 bytes - priority
    14                                  ; 28 bytes - general purpose registers
    15                                  
    16                                  LL_IND: EQU 0
    17                                  PR_IND: EQU 2   ;priority
    18                                  AX_IND: EQU 4
    19                                  BX_IND: EQU 6
    20                                  CX_IND: EQU 8
    21                                  DX_IND: EQU 10
    22                                  SI_IND: EQU 12
    23                                  DI_IND: EQU 14
    24                                  BP_IND: EQU 16
    25                                  SP_IND: EQU 18
    26                                  CS_IND: EQU 20
    27                                  DS_IND: EQU 22
    28                                  ES_IND: EQU 24
    29                                  SS_IND: EQU 26
    30                                  FLAG_IND: EQU 28
    31                                  IP_IND: EQU 30
    32                                  
    33                                  ;receieves argument in ax
    34                                  getNext:
    35 00002209 89C3                        mov bx, ax
    36 0000220B C1E305                      shl bx, 5
    37 0000220E 8B87[0700]                  mov ax, [PCB+LL_IND+bx]
    38 00002212 25FF00                      and ax, 0x00FF  ;to discord 'prev' pointer
    39 00002215 C3                          ret
    40                                  
    41                                  int08isr:
    42 00002216 53                          push bx
    43 00002217 8B1E[0722]                  mov bx, [currProc]
    44 0000221B C1E305                      shl bx, 5
    45                                  
    46                                      ;STORE
    47                                      ;general purpose registers
    48 0000221E 8987[0B00]                  mov [PCB+AX_IND+bx], ax
    49 00002222 58                          pop ax
    50 00002223 8987[0D00]                  mov [PCB+BX_IND+bx], ax
    51 00002227 898F[0F00]                  mov [PCB+CX_IND+bx], cx
    52 0000222B 8997[1100]                  mov [PCB+DX_IND+bx], dx
    53 0000222F 89B7[1300]                  mov [PCB+SI_IND+bx], si
    54 00002233 89BF[1500]                  mov [PCB+DI_IND+bx], di
    55 00002237 89AF[1700]                  mov [PCB+BP_IND+bx], bp
    56 0000223B 8C9F[1D00]                  mov [PCB+DS_IND+bx], ds
    57 0000223F 8C87[1F00]                  mov [PCB+ES_IND+bx], es
    58                                  
    59                                      ;iret relevant registers
    60 00002243 58                          pop ax
    61 00002244 8987[2500]                  mov [PCB+IP_IND+bx], ax
    62 00002248 58                          pop ax
    63 00002249 8987[1B00]                  mov [PCB+CS_IND+bx], ax
    64 0000224D 58                          pop ax
    65 0000224E 8987[2300]                  mov [PCB+FLAG_IND+bx], ax
    66                                  
    67                                      ;stack relevant registers
    68 00002252 8C97[2100]                  mov [PCB+SS_IND+bx], ss
    69 00002256 89A7[1900]                  mov [PCB+SP_IND+bx], sp
    70                                  
    71 0000225A A1[0722]                    mov ax, [currProc]
    72 0000225D E8A9FF                      call getNext       ;ax = next
    73 00002260 A3[0722]                    mov [currProc], ax
    74 00002263 89C3                        mov bx, ax
    75 00002265 C1E305                      shl bx, 5
    76                                      
    77                                      ;RESTORE
    78                                      ;stack registers
    79 00002268 FA                          cli
    80 00002269 8B87[2100]                  mov ax, [PCB+SS_IND+bx]
    81 0000226D 8ED0                        mov ss, ax
    82 0000226F 8B87[1900]                  mov ax, [PCB+SP_IND+bx]
    83 00002273 89C4                        mov sp, ax
    84 00002275 FB                          sti
    85                                  
    86                                      ;iret relevant registers
    87 00002276 8B87[2300]                  mov ax, [PCB+FLAG_IND+bx]
    88 0000227A 50                          push ax
    89 0000227B 8B87[1B00]                  mov ax, [PCB+CS_IND+bx]
    90 0000227F 50                          push ax
    91 00002280 8B87[2500]                  mov ax, [PCB+IP_IND+bx]
    92 00002284 50                          push ax
    93                                  
    94                                      ;general purpose registers
    95 00002285 8B8F[0F00]                  mov cx, [PCB+CX_IND+bx]
    96 00002289 8B97[1100]                  mov dx, [PCB+DX_IND+bx]
    97 0000228D 8BB7[1300]                  mov si, [PCB+SI_IND+bx]
    98 00002291 8BBF[1500]                  mov di, [PCB+DI_IND+bx]
    99 00002295 8BAF[1700]                  mov bp, [PCB+BP_IND+bx]
   100 00002299 8E9F[1D00]                  mov ds, [PCB+DS_IND+bx]
   101 0000229D 8E87[1F00]                  mov es, [PCB+ES_IND+bx]
   102                                  
   103                                      ;EoI + restore ax, bx
   104 000022A1 B020                        mov al, 0x20
   105 000022A3 E620                        out 0x20, al
   106                                  
   107 000022A5 8B87[0B00]                  mov ax, [PCB+AX_IND+bx]
   108 000022A9 8B9F[0D00]                  mov bx, [PCB+BX_IND+bx]
   109                                  
   110 000022AD CF                          iret
   111                                  
   112                                  start:
   113 000022AE 31C0                        xor ax, ax 
   114 000022B0 8EC0                        mov es, ax
   115                                  
   116                                      ;store old ISR
   117 000022B2 2666A12000                  mov eax, [es:8*4]
   118 000022B7 66A3[0300]                  mov dword [oldtt], eax
   119                                      
   120                                      ;Replace ISR
   121 000022BB FA                          cli
   122 000022BC 268C0E2200                  mov word [es:8*4+2], cs
   123 000022C1 26C7062000[1622]            mov word [es:8*4], int08isr
   124 000022C8 FB                          sti
   125                                  
   126                                      ;TSR				
   127 000022C9 BA[AE22]                    mov dx, start
   128 000022CC 81C20F00                    add dx, 15
   129 000022D0 B104                        mov cl, 4
   130 000022D2 D3EA                        shr dx, cl
   131 000022D4 B80031                      mov ax, 3100h
   132 000022D7 CD21                        int 21h
